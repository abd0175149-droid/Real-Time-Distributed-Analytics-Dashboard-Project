# مقارنة آلية التحليلات ومنطق العمل ونوع البيانات المخزنة
## هل يتم التحليل ثم التخزين أم تخزين بيانات ثم الاستعلام عنها؟

---

## 1. المنطق في التوثيق (المقصود به)

### 1.1 نوع البيانات المخزنة
- **جداول أحداث خام (Raw Events):** تخزين **كل حدث** كما وصل من المتصفح:
  - `sessions` — جلسة واحدة لكل زيارة (جهاز، موقع، referrer، …)
  - `page_events` — كل page_load, page_view, page_unload (مع أداء، مدة، scroll، …)
  - `interaction_events` — نقرات، تمرير، روابط
  - `form_events` — تفاعلات النماذج
  - `ecommerce_events` — أحداث التجارة (عرض منتج، سلة، شراء)
  - `video_events` — أحداث الفيديو (تشغيل، إيقاف، إكمال، نسب مشاهدة)

- **جداول تجميع (Pre-aggregated):** تخزين **نتائج تحليل جاهزة** لفترات زمنية (5m, 1h, 1d):
  - `traffic_metrics` — عدد المستخدمين، الجلسات، معدل الارتداد، متوسط المدة، …
  - `page_metrics` — عدد المشاهدات لكل صفحة، وقت البقاء، عمق التمرير، …
  - `device_metrics`, `geo_metrics`, `source_metrics`, إلخ.

### 1.2 آلية العمل حسب التوثيق
```
┌─────────────────────────────────────────────────────────────────────────────┐
│  التوثيق: تدفق "تخزين ثم تحليل تلقائي ثم استعلام عن المجمّع"               │
└─────────────────────────────────────────────────────────────────────────────┘

  1) التخزين (Write)
     المتصفح ──► API ──► تخزين أحداث خام في:
                         sessions, page_events, interaction_events,
                         form_events, ecommerce_events, video_events

  2) التحليل (Analysis) — تلقائي داخل ClickHouse
     عند كل INSERT في الجداول الخام، الـ Materialized Views تُشغّل استعلامات
     تجميع (GROUP BY, COUNT, uniq, avg, …) وتُدخل النتائج في:
                         traffic_metrics, page_metrics, device_metrics,
                         geo_metrics, إلخ.

  3) العرض (Read)
     لوحة التحكم ──► API ──► استعلام عن جداول التجميع (traffic_metrics,
                             page_metrics, …) حسب الفترة (5m, 1h, 1d)
                             ← قراءة مقاييس جاهزة، بدون GROUP BY على الخام.
```

**الخلاصة حسب التوثيق:**
- **التخزين:** أحداث خام فقط (لا تحليل قبل التخزين).
- **التحليل:** يحدث **بعد التخزين** تلقائياً داخل ClickHouse عبر Materialized Views، وتُخزَّن النتائج في جداول التجميع.
- **العرض:** استعلام عن **البيانات المجمّعة مسبقاً** (traffic_metrics, page_metrics، …)، وليس استعلاماً عن الخام مع GROUP BY عند كل طلب.

أي أن المنطق الموثّق: **تخزين بيانات خام → تحليل تلقائي (MVs) → تخزين مقاييس → الاستعلام عن المقاييس**.

---

## 2. المنطق في التنفيذ الحالي (الكود)

### 2.1 نوع البيانات المخزنة
- **نفس الجداول الخام** موجودة ويتم الكتابة فيها:
  - `sessions`, `page_events`, `interaction_events`, `form_events`
  - `ecommerce_events`, `video_events` موجودان في الـ schema لكن أحداث E-commerce و Video تُخزَّن حالياً في `interaction_events` فقط (كما في تحليل الفجوة).

- **جداول التجميع** موجودة في الـ schema، وتُملأ **تلقائياً** عبر نفس الـ Materialized Views الموثّقة (عند INSERT في الجداول الخام).

### 2.2 آلية العمل في الكود الحالي
```
┌─────────────────────────────────────────────────────────────────────────────┐
│  التنفيذ الحالي: تخزين خام + تحليل تلقائي (MVs) + لكن العرض من الخام!      │
└─────────────────────────────────────────────────────────────────────────────┘

  1) التخزين (Write) — مثل التوثيق
     المتصفح ──► API ──► insertSession, insertEvent, insertInteractionEvent,
                         insertFormEvent في الجداول الخام.

  2) التحليل التلقائي (MVs) — يعمل كما في التوثيق
     كل INSERT في الخام يُفعّل الـ MVs فتُملأ traffic_metrics, page_metrics,
     device_metrics, geo_metrics, إلخ.

  3) العرض (Read) — يختلف عن التوثيق
     لوحة التحكم ──► getOverviewStats(), getTrafficData(), getTopPages(),
                     getDeviceStats(), getGeoStats(), getRealTimeStats()
                     ──► كلها تستعلم من الجداول الخام (page_events, sessions)
                     مع استعلامات تحليلية في وقت الطلب:
                     GROUP BY, uniq(), countIf(), avg(), …
                     ← تحليل عند القراءة (Analyze on read)، وليس قراءة مجمّع جاهز.
```

**ملاحظة:** الدالة `getTrafficMetrics()` التي تستعلم من `traffic_metrics` **موجودة** في الخدمة لكن **لا تُستدعى** من `DashboardStatsController`؛ المستخدم فعلياً هو `getOverviewStats` و `getTrafficData` اللتان تعتمدان على `page_events` و `sessions`.

---

## 3. جدول المقارنة المباشر

| الجانب | التوثيق (المقصود) | التنفيذ الحالي |
|--------|-------------------|-----------------|
| **ما يُخزَّن أولاً** | أحداث خام فقط (كل حدث كما أتى) | نفس الشيء: أحداث خام في الجداول الأساسية ✓ |
| **هل يُجرى تحليل قبل التخزين؟** | لا؛ التخزين للأحداث الخام فقط | لا ✓ |
| **أين يحدث التحليل؟** | داخل ClickHouse بعد الـ INSERT، عبر Materialized Views | نفس الشيء؛ الـ MVs تعمل وتُملأ جداول التجميع ✓ |
| **ما الذي يُخزَّن نتيجة التحليل؟** | مقاييس مجمّعة في traffic_metrics, page_metrics, device_metrics, geo_metrics, … | نفس الجداول تُملأ بواسطة الـ MVs ✓ |
| **عند عرض لوحة التحكم، من أين تُقرأ البيانات؟** | من جداول التجميع (traffic_metrics, page_metrics، …) — مقاييس جاهزة | من الجداول الخام (page_events, sessions) مع GROUP BY و uniq و countIf و avg عند كل طلب ✗ |
| **أسلوب القراءة** | قراءة مجمّع مُحسوب مسبقاً (Pre-aggregated) | تحليل عند القراءة (Analyze on read) على الخام |

---

## 4. الإجابة المختصرة على سؤالك

- **هل يتم التحليل ثم التخزين؟**  
  **لا** في الاثنين: لا التوثيق ولا التنفيذ الحالي يقيما تحليلاً ثم يخزنا ناتجه كأحداث. التخزين الأولي هو **أحداث خام** فقط.

- **هل يتم تخزين بيانات ثم الاستعلام عنها؟**  
  **نعم** في الاثنين، لكن بمعنيين:
  - **التوثيق:** تخزين أحداث خام → تحليل تلقائي (MVs) يملأ جداول التجميع → الاستعلام عن **هذه الجداول المجمّعة** (استعلام عن نتائج تحليل جاهزة).
  - **التنفيذ الحالي:** تخزين أحداث خام → نفس التحليل التلقائي (MVs) يملأ جداول التجميع، لكن لوحة التحكم **لا تستخدمها** وتستعلم بدلاً ذلك من **الخام** (page_events, sessions) وتُجري الـ GROUP BY والتحليل **عند كل استعلام** (استعلام عن الخام ثم تحليل على الطاير).

الفرق الجوهري إذن: **نوع الاستعلام** عند العرض — موثّق: استعلام عن المجمّع؛ حالي: استعلام عن الخام مع تحليل عند القراءة.

---

## 5. إن رغبت بمطابقة المنطق الحالي للتوثيق (عرض من التجميع)

- استدعاء **getTrafficMetrics(trackingId, interval)** (أو دوال مشابهة) من جداول مثل `traffic_metrics`, `page_metrics` عند عرض فترات 5m / 1h / 1d.
- استخدام نتائجها في **DashboardStatsController** (مثلاً لـ overview و traffic) بدلاً من الاعتماد الكامل على **getOverviewStats** و **getTrafficData** القائمتين على `page_events` و `sessions`.
- الإبقاء على الاستعلام من الخام (مثلاً getOverviewStats) للفترات المخصصة أو عندما تحتاج لوحة التحكم تفاصيل لا تتوفر في جداول التجميع.

بهذا يصبح: **تخزين بيانات خام → تحليل تلقائي (MVs) → تخزين مقاييس → الاستعلام عن المقاييس** كما في التوثيق.
